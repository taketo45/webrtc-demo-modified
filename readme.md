# WebRTC配信テストアプリ

このアプリケーションは、Cloudflare StreamのWHIP（WebRTC-HTTP Ingestion Protocol）とWHEP（WebRTC-HTTP Egress Protocol）を利用した簡易的なビデオ配信・視聴システムです。ブラウザだけでライブストリーミングのテストが可能です。

## セットアップ手順

### 1. 前提条件
- Cloudflareアカウント
- Cloudflare Streamへのアクセス権
- 最新のWebブラウザ（Chrome, Firefox, Edgeなど）

### 2. ファイル構成
```
├── broadcaster.html      # 配信側ページ
├── broadcaster.js        # 配信側スクリプト
├── viewer.html           # 視聴側ページ
├── viewer.js             # 視聴側スクリプト
├── stream-styles.css     # スタイルシート
├── WHIPClient.js         # WHIP実装（配信プロトコル）
├── WHEPClient.js         # WHEP実装（視聴プロトコル）
└── negotiateConnectionWithClientOffer.js # WebRTC接続処理
```

### 3. CloudflareでのURL取得

1. Cloudflareダッシュボードにログイン
2. Stream > ライブ入力 に移動
3. 新しいライブ入力を作成
4. 「WebRTC」タブでWHIPエンドポイントURLを取得（配信用）
5. 「ライブ再生とレコーディング」を有効化
6. WebRTC再生URLを取得（視聴用）

### 4. アプリの開始

#### サーバー起動方法
- 簡易的なWebサーバーでファイルを提供します
- Node.jsがインストールされている場合: `npx http-server`
- Python 3がインストールされている場合: `python -m http.server 8080`

#### ローカル開発環境の場合
1. `npm install` で依存パッケージをインストール
2. `npm run dev` で開発サーバーを起動

## 使用方法

### 配信側（broadcaster.html）
1. ページにアクセスするとカメラとマイクの許可を求められます
2. WHIPエンドポイントURLを入力（Cloudflareから取得したもの）
3. 「配信開始」ボタンをクリックして配信を開始
4. 配信情報が表示され、配信状態を確認できます
5. 「配信停止」ボタンで配信を終了できます

### 視聴側（viewer.html）
1. WHEPエンドポイントURLを入力（Cloudflareから取得したもの）
2. 「視聴開始」ボタンをクリックして配信の視聴を開始
3. 視聴情報が表示され、接続状態を確認できます
4. 「視聴停止」ボタンで視聴を終了できます

## 注意事項

- WHIPとWHEPのエンドポイントURLには秘密キーが含まれています。公開リポジトリにコミットしないでください。
- カメラとマイクへのアクセス許可が必要です。
- WebRTC接続にはSTUNサーバーを使用しています（Cloudflare提供のものを利用）。
- 同一ネットワーク内でも、配信と視聴は別々のブラウザまたはタブで行うことをお勧めします。
- ネットワーク環境によって配信品質や遅延が変わることがあります。

## トラブルシューティング

1. **カメラ/マイクにアクセスできない**
   - ブラウザの権限設定を確認してください
   - デバイスが正しく接続されているか確認してください

2. **接続エラーが発生する**
   - WHIPおよびWHEPのURLが正しいか確認してください
   - Cloudflareアカウントで適切な権限があるか確認してください
   - ネットワークのファイアウォール設定を確認してください

3. **視聴側で映像が表示されない**
   - 配信が正常に開始されているか確認してください
   - Cloudflareダッシュボードで「ライブ再生とレコーディング」が有効になっているか確認してください

4. **映像品質が悪い**
   - ネットワーク帯域幅を確認してください
   - カメラの解像度設定を確認してください
